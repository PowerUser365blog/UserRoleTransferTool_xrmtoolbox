using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace UserRoleTransferTool
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "User's role transfer tool"),
        ExportMetadata("Description", "Transfer roles between users or teams."),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "#FAF8EC"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MyPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new UserRoleTransferToolControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MyPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}